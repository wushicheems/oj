name: Wake Codespace

on:
  schedule:
    # every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch: {}

jobs:
  wake:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Install GitHub CLI
        run: |
          # 安装最新版 GitHub CLI
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y
          
      - name: Verify GitHub CLI installation
        run: |
          echo "GitHub CLI version:"
          gh --version
          echo ""
          echo "Available commands:"
          gh codespace --help
          
      - name: Authenticate with PAT
        env:
          CODESPACE_PAT: ${{ secrets.CODESPACE_PAT }}
        run: |
          if [ -z "$CODESPACE_PAT" ]; then
            echo "ERROR: CODESPACE_PAT secret is not set."
            echo "Please add a Personal Access Token with 'codespaces' scope to repository secrets as 'CODESPACE_PAT'."
            exit 1
          fi
          echo "Authenticating with GitHub..."
          echo "$CODESPACE_PAT" | gh auth login --with-token --hostname github.com
          echo "Authentication successful"
          
      - name: Check and wake codespace
        env:
          CODESPACE_PAT: ${{ secrets.CODESPACE_PAT }}
        run: |
          REPO="${{ github.repository }}"
          echo "Processing repository: $REPO"
          
          # 获取 codespace 信息
          echo "Getting codespace information..."
          CODESPACE_INFO=$(gh codespace list --repo "$REPO" --json name,state,gitStatus 2>/dev/null || echo "[]")
          
          if [ "$CODESPACE_INFO" = "[]" ]; then
            echo "No existing codespace found. Trying to create one..."
            # 尝试创建 codespace
            gh codespace create --repo "$REPO" --branch "master" --default-permissions || echo "Codespace creation failed or not permitted"
            exit 0
          fi
          
          # 提取 codespace 名称
          CODESPACE_NAME=$(echo "$CODESPACE_INFO" | jq -r '.[0].name // empty')
          
          if [ -z "$CODESPACE_NAME" ]; then
            echo "Could not extract codespace name"
            exit 0
          fi
          
          echo "Found codespace: $CODESPACE_NAME"
          
          # 检查状态
          CODESPACE_STATE=$(echo "$CODESPACE_INFO" | jq -r '.[0].state // empty')
          echo "Current state: $CODESPACE_STATE"
          
          # 方法1: 使用 API 来启动 (如果状态不是 Available)
          if [ "$CODESPACE_STATE" != "Available" ]; then
            echo "Codespace is not available ($CODESPACE_STATE). Attempting to wake it..."
            
            # 使用 curl 调用 GitHub API 来启动 codespace
            API_URL="https://api.github.com/user/codespaces/$CODESPACE_NAME/start"
            echo "Calling API: $API_URL"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: token $CODESPACE_PAT" \
              -H "Content-Type: application/json" \
              "$API_URL" 2>/dev/null || echo "ERROR\n000")
              
            HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
            
            echo "HTTP Status: $HTTP_STATUS"
            if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "201" ] || [ "$HTTP_STATUS" = "202" ]; then
              echo "✓ Codespace start requested successfully"
              echo "Response: $RESPONSE_BODY"
            else
              echo "⚠ Could not start codespace via API (Status: $HTTP_STATUS)"
              echo "Response: $RESPONSE_BODY"
            fi
          else
            echo "✓ Codespace is already available"
          fi
          
          # 等待一下让 codespace 启动
          echo "Waiting for codespace to be ready..."
          sleep 10
          
      - name: Set port visibility
        env:
          CODESPACE_PAT: ${{ secrets.CODESPACE_PAT }}
        run: |
          REPO="${{ github.repository }}"
          
          # 再次获取 codespace 名称
          CODESPACE_NAME=$(gh codespace list --repo "$REPO" --json name --jq '.[0].name' 2>/dev/null || echo "")
          
          if [ -z "$CODESPACE_NAME" ]; then
            echo "No codespace found, skipping port configuration"
            exit 0
          fi
          
          echo "Configuring port 80 visibility for: $CODESPACE_NAME"
          
          # 设置端口 80 为公开
          API_URL="https://api.github.com/user/codespaces/$CODESPACE_NAME/ports/80"
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Attempt $RETRY_COUNT to set port visibility..."
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: token $CODESPACE_PAT" \
              -H "Content-Type: application/json" \
              "$API_URL" -d '{"visibility":"public"}' 2>/dev/null || echo "ERROR\n000")
              
            HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "✓ Port 80 set to public visibility"
              break
            else
              echo "⚠ Attempt $RETRY_COUNT failed (Status: $HTTP_STATUS)"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                sleep 5
              fi
            fi
          done
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "⚠ Could not set port visibility after $MAX_RETRIES attempts"
          fi
          
      - name: Complete
        run: echo "✅ Codespace wake-up process completed"
