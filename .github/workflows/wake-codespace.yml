name: HOJ Codespace Auto-Wake

on:
  schedule:
    # æ¯10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œä¿æŒæ´»è·ƒ
    - cron: '*/10 * * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'é€‰æ‹©æ“ä½œ'
        required: true
        default: 'wake'
        type: choice
        options:
        - wake
        - restart-docker
        - stop-docker

jobs:
  maintain:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI and dependencies
        run: |
          # å®‰è£…æœ€æ–°ç‰ˆ GitHub CLI
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install -y gh curl jq
          
      - name: Authenticate with PAT
        env:
          CODESPACE_PAT: ${{ secrets.CODESPACE_PAT }}
        run: |
          if [ -z "$CODESPACE_PAT" ]; then
            echo "âŒ CODESPACE_PAT æœªè®¾ç½®"
            echo "è¯·åˆ›å»º Personal Access Tokenï¼Œéœ€è¦ codespaces æƒé™"
            echo "ç„¶åæ·»åŠ åˆ°ä»“åº“ Secrets ä¸­ï¼Œåç§°ä¸º CODESPACE_PAT"
            exit 1
          fi
          echo "$CODESPACE_PAT" | gh auth login --with-token
          
      - name: Get codespace information
        id: codespace-info
        env:
          CODESPACE_PAT: ${{ secrets.CODESPACE_PAT }}
        run: |
          REPO="${{ github.repository }}"
          echo "å¤„ç†ä»“åº“: $REPO"
          
          # è·å– codespace ä¿¡æ¯
          CODESPACE_JSON=$(gh codespace list --repo "$REPO" --json name,state,gitStatus,displayName 2>/dev/null || echo "[]")
          
          if [ "$CODESPACE_JSON" = "[]" ]; then
            echo "æ²¡æœ‰æ‰¾åˆ° codespace"
            echo "codespace_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          CODESPACE_NAME=$(echo "$CODESPACE_JSON" | jq -r '.[0].name // empty')
          CODESPACE_STATE=$(echo "$CODESPACE_JSON" | jq -r '.[0].state // empty')
          CODESPACE_DISPLAY_NAME=$(echo "$CODESPACE_JSON" | jq -r '.[0].displayName // empty')
          
          if [ -z "$CODESPACE_NAME" ]; then
            echo "æ— æ³•è·å– codespace åç§°"
            echo "codespace_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "æ‰¾åˆ° codespace: $CODESPACE_DISPLAY_NAME ($CODESPACE_NAME)"
          echo "å½“å‰çŠ¶æ€: $CODESPACE_STATE"
          
          echo "codespace_exists=true" >> $GITHUB_OUTPUT
          echo "codespace_name=$CODESPACE_NAME" >> $GITHUB_OUTPUT
          echo "codespace_state=$CODESPACE_STATE" >> $GITHUB_OUTPUT
          
      - name: Start codespace if stopped
        if: steps.codespace-info.outputs.codespace_exists == 'true' && steps.codespace-info.outputs.codespace_state != 'Available'
        env:
          CODESPACE_PAT: ${{ secrets.CODESPACE_PAT }}
          CODESPACE_NAME: ${{ steps.codespace-info.outputs.codespace_name }}
        run: |
          echo "å¯åŠ¨ codespace: $CODESPACE_NAME"
          
          # ä½¿ç”¨ API å¯åŠ¨ codespace
          API_URL="https://api.github.com/user/codespaces/$CODESPACE_NAME/start"
          
          echo "è°ƒç”¨ API: $API_URL"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token $CODESPACE_PAT" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL" 2>/dev/null || echo "ERROR\n000")
            
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP çŠ¶æ€ç : $HTTP_STATUS"
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "202" ]; then
            echo "âœ… Codespace å¯åŠ¨è¯·æ±‚å·²å‘é€"
            echo "å“åº”: $RESPONSE_BODY"
          else
            echo "âš  æ— æ³•å¯åŠ¨ codespace (çŠ¶æ€ç : $HTTP_STATUS)"
            echo "å“åº”: $RESPONSE_BODY"
          fi
          
      - name: Wait for codespace to be ready
        if: steps.codespace-info.outputs.codespace_exists == 'true'
        run: |
          echo "ç­‰å¾… codespace å¯åŠ¨..."
          sleep 25
          echo "ç­‰å¾…å®Œæˆ"
          
      - name: Configure HOJ ports visibility
        if: steps.codespace-info.outputs.codespace_exists == 'true'
        env:
          CODESPACE_PAT: ${{ secrets.CODESPACE_PAT }}
          CODESPACE_NAME: ${{ steps.codespace-info.outputs.codespace_name }}
        run: |
          echo "é…ç½® HOJ ç«¯å£å¯è§æ€§..."
          
          # HOJ å¸¸ç”¨ç«¯å£
          HOJ_PORTS="80 443 3306 6379 8080 8999 8888 3000"
          
          for PORT in $HOJ_PORTS; do
            echo "è®¾ç½®ç«¯å£ $PORT ä¸ºå…¬å¼€..."
            API_URL="https://api.github.com/user/codespaces/$CODESPACE_NAME/ports/$PORT"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: token $CODESPACE_PAT" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Content-Type: application/json" \
              "$API_URL" -d '{"visibility":"public"}' 2>/dev/null || echo "ERROR\n000")
              
            HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… ç«¯å£ $PORT å·²è®¾ä¸ºå…¬å¼€"
            elif [ "$HTTP_STATUS" = "404" ]; then
              echo "â– ç«¯å£ $PORT æœªå¼€æ”¾"
            else
              echo "âš  ç«¯å£ $PORT è®¾ç½®å¤±è´¥ (çŠ¶æ€ç : $HTTP_STATUS)"
            fi
          done
          
      - name: Check HOJ health status
        if: steps.codespace-info.outputs.codespace_exists == 'true' && github.event_name == 'workflow_dispatch'
        env:
          CODESPACE_PAT: ${{ secrets.CODESPACE_PAT }}
          CODESPACE_NAME: ${{ steps.codespace-info.outputs.codespace_name }}
        run: |
          echo "æ£€æŸ¥ HOJ å¥åº·çŠ¶æ€..."
          
          # è·å– codespace çš„å…¬å¼€ URL
          API_URL="https://api.github.com/user/codespaces/$CODESPACE_NAME"
          CODESPACE_DETAILS=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token $CODESPACE_PAT" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL")
            
          WEB_URL=$(echo "$CODESPACE_DETAILS" | jq -r '.web_url // empty')
          
          if [ -n "$WEB_URL" ]; then
            echo "ğŸŒ HOJ è®¿é—®åœ°å€: $WEB_URL"
            echo "è®¿é—®åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆå¦‚æœæ”¯æŒï¼‰"
            echo "::notice::HOJ è®¿é—®åœ°å€: $WEB_URL"
          else
            echo "æ— æ³•è·å–è®¿é—®åœ°å€"
          fi
          
      - name: Create HOJ startup reminder
        run: |
          echo "========================================="
          echo "âœ… HOJ Codespace ç»´æŠ¤å®Œæˆ"
          echo "========================================="
          echo ""
          echo "HOJ ç³»ç»Ÿåº”è¯¥å·²ç»å¯åŠ¨å¹¶è¿è¡Œ"
          echo ""
          echo "å¦‚æœ docker-compose æ²¡æœ‰è‡ªåŠ¨å¯åŠ¨ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œ:"
          echo "cd /workspaces/oj/standAlone && docker-compose up -d"
          echo ""
          echo "å¸¸è§é—®é¢˜æ’æŸ¥:"
          echo "1. æ£€æŸ¥ docker çŠ¶æ€: docker ps"
          echo "2. æŸ¥çœ‹æ—¥å¿—: docker-compose logs"
          echo "3. é‡å¯æœåŠ¡: docker-compose restart"
          echo ""
          echo "========================================="
