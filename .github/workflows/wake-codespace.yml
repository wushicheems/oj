name: Wake Codespace

on:
  schedule:
    # every 30 minutes
    - cron: '*/28 * * * *'
  workflow_dispatch: {}

jobs:
  wake:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Install GitHub CLI
        uses: cli/gh-action@v2

      - name: Authenticate with PAT
        env:
          CODESPACE_PAT: ${{ secrets.CODESPACE_PAT }}
        run: |
          if [ -z "$CODESPACE_PAT" ]; then
            echo 'CODESPACE_PAT secret is not set. Please add a PAT with `codespaces` scope to repository secrets as `CODESPACE_PAT`.'
            exit 1
          fi
          echo "$CODESPACE_PAT" | gh auth login --with-token

      - name: Find and start/create codespace
        run: |
          REPO=${{ github.repository }}
          echo "Repository: $REPO"
          # try to find an existing codespace for this repo
          CODESPACE_NAME=$(gh codespace list --repo "$REPO" --json name --jq '.[0].name' || echo "")
          if [ -n "$CODESPACE_NAME" ]; then
            echo "Starting codespace: $CODESPACE_NAME"
            gh codespace start -c "$CODESPACE_NAME"
          else
            echo "No existing codespace found for $REPO. Attempting to create one..."
            gh codespace create --repo "$REPO" --branch "master" || echo "create failed or not permitted"
          fi

      - name: Make port 80 public
        env:
          CODESPACE_PAT: ${{ secrets.CODESPACE_PAT }}
        run: |
          REPO=${{ github.repository }}
          CODESPACE_NAME=$(gh codespace list --repo "$REPO" --json name --jq '.[0].name' || echo "")
          if [ -z "$CODESPACE_NAME" ]; then
            echo "No codespace found for $REPO; skipping port visibility update."
          else
            echo "Setting port 80 visibility to public for codespace: $CODESPACE_NAME"
            curl -s -X PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: token $CODESPACE_PAT" \
              -H "Content-Type: application/json" \
              "https://api.github.com/user/codespaces/$CODESPACE_NAME/ports/80" \
              -d '{"visibility":"public"}' | jq || true
          fi

      - name: Done
        run: echo "Wake attempt finished"
